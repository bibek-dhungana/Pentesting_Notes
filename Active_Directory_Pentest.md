# Active Directory Overview
- What is Active Directory?
  - Directory service developed by Microsoft to manage Windows
    domain networks.
   - Stores information related to objects, such as Computers, Users,
    Printers, etc.
  - Think about it as a phone book for Windows
  - Authenticates using Kerberos tickets.
  - Non-Windows devices, such as Linux machines, firewalls, etc. can also
   authenticate to Active Directory via RADIUS or LDAP.
  
 # Why Active Directory Pentest ?
- Active Directory is the most commonly used identity management
service in the corporate organization infrastructure.
- Can be exploited without ever attacking patchable exploits.
- Instead, we abuse features, trusts, components, and more.

# Physical Component

   **Domain Controllers**
   - A domain controller is a server with the AD DS server role installed that has
    specifically been promoted to a domain controller.

    - Host a copy of the AD DS directory store
    - Provide authentication and authorization services
    - Replicate updates to other domain controllers in the domain and forest
    - Allow administrative access to manage user accounts and network resources

  **AD DS Data Store**
   - The AD DS data store contains the database files and processes that store and
     manage directory information for users, services, and applications

  - The AD DS data store:
      - Consists of the Ntds.dit file
      - Is stored by default in the %SystemRoot%\NTDS folder on all domain
        controllers.

      - Is accessible only through the domain controller processes and protocols.

# Logical AD Components

 **AD DS Schema**
 The AD DS Schema:
 Defines every type of object that can be stored in the directory
 Enforces rules regarding object creation and configuration

 **Domains**
 Domains are used to group and manage objects in an
 organization

 **Domains:**
 • An administrative boundary for applying policies to groups of objects
  A replication boundary for replicating data between domain controllers
 • An authentication and authorization boundary that provides a way to limit the
Scope of access to resources

 **Trees**
  A domain tree is a hierarchy of domains in AD DS

All domains in the tree:
• Share a contiguous namespace with the parent domain.
· Can have additional child domains
• By default create a two-way trarsitive trust with other domains



**Forests:**
 A forest is a collection of
 one or more domain trees.
 Share a common schema
• Share a common configuration partition
• Share a common global catalog to enable searching
Enable trusts between all domains in the forest
Share the Enterprise Admins and Schema Admins groups

 **Organizational Units (Ous)**
 OUs are Active Directory containers that can contain users, groups, computers, and
 other OUs

 **OUs are used to:**
 Represent your organization hierarchically and logically
• Manage a collection of objects in a consistent way
Delegate permissions to administer groups of objects
• Apply policies

 **Trusts:**

 Trusts provide a mechanism for users to gain access to resources in another domain

**Directional:**

 The trust direction flows from
 trusting domain to the trusted
 domain

 **Transitive**

 The trust relationship is extended
 beyond a two-domain trust to
 include other trusted domains

 **Note:**

 All domains in a forest trust all other domains in the forest
 Trusts can extend outside the forest.

# Common AD Misconfigurations
 **Excessive sharing:** 
- Too often file shares (and things like
  SharePoint) have sensitive data that is
   over shared
 - Increases impact of breach
 - Attacker doesn't need to pivot
 - Attacker already has access to the data
 - How are you going to alert on access to a central file share?
- The attacker doesn't need all your data, just some of it

**Useful tool :**

 - PowerView "is a PowerShell tool to gain network situational
awareness on Windows domains."
[https://github.com/PowerShellMafia/PowerSploit/blob/dev/Recon/PowerView.ps1](https://github.com/PowerShellMafia/PowerSploit/blob/dev/Recon/PowerView.ps1)

  - By default it will look..
  - Across all systems all shares
  - For files named *password*, *sensitive*, *admin*, *login*,
   *secret*, unattend*.xml, *.vmdk, *creds*, *credential*, *.config

   **Read More:**
     - [redsiege.com/goal](http://redsiege.com/goal)
  
  **Passwords in AD Description:**
 - Too often password information is in
 - clear text in the AD user
Admins assume only admins can read it

- Many tools exists to extract this info
 - PowerShell 
 - DS Commands
 - LDAP Queries
 - AD Explorer

- Powershell commands:

 `Get-ADUser -Filter * -Properties Description | Where-Object {
$ . Description.length -gt 8 }`

**Nested Groups:**
 - Too much nesting means you may loose
 - sight of who actually has permissions.
 - Attacker either doesn't need to pivot or needs to pivot less
 - Read More: 
   - Finding the silver lining in getting your teeth kicked in
     [redsiege.com/silver](http://redsiege.com/silver)

 - DS Commands allow for recursive searching 
  `dsquery group -name "Domain Admins" | dsget group -expand -members`

-  Extra Resources:
   - Beyond Net User - Part 2: DS Commands
     [redsiege.com/ds](http://redsiege.com/ds)


